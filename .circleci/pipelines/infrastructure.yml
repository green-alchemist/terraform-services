version: 2.1

orbs:
  # The 'monorepo-orb' name is an alias we defined in the main config.yml.
  monorepo: monorepo-orb/orb@dev:alpha
  aws-cli: circleci/aws-cli@3.1.1
  terraform: circleci/terraform@3.7.0

anchors:
  - &context
    context:
      - circleci-secrets
      - slack-notifications
  - &branch_filter
    filters:
      branches:
        only:
          - kyle

workflows:
  # This workflow only runs if it was triggered by the top-level path-filtering job.
  terraform-ci-cd:
    jobs:
      - monorepo/terraform_ci_job:
          name: terraform_validate
          mode: validate
          <<: *context
          <<: *branch_filter
      - monorepo/terraform_ci_job:
          name: terraform_plan
          mode: plan
          <<: *context
          <<: *branch_filter
          requires:
            - terraform_validate
      - hold-for-apply:
          type: approval
          requires:
            - terraform_plan
      - monorepo/terraform_ci_job:
          name: terraform_apply
          mode: apply
          <<: *context
          <<: *branch_filter
          requires:
            - hold-for-apply
